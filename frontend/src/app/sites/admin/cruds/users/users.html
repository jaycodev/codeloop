<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<p-toolbar styleClass="mb-4">
  <ng-template pTemplate="left">
    <button
      pButton
      pRipple
      label="Nuevo Usuario"
      icon="pi pi-plus"
      class="p-button-success mr-2"
      (click)="openNew()"
    ></button>
    <button
      pButton
      pRipple
      label="Eliminar"
      icon="pi pi-trash"
      class="p-button-danger"
      [disabled]="!selectedUsers || selectedUsers.length === 0"
      (click)="deleteSelectedUsers()"
    ></button>
  </ng-template>
  <ng-template pTemplate="right">
    <p-iconField iconPosition="left">
      <p-inputIcon class="pi pi-search"></p-inputIcon>
      <input
        pInputText
        type="text"
        (input)="onGlobalFilter(dt, $event)"
        placeholder="Buscar..."
      />
    </p-iconField>
  </ng-template>
</p-toolbar>

<p-table
  #dt
  [value]="users()"
  [columns]="cols"
  [rows]="10"
  [paginator]="true"
  [globalFilterFields]="['name', 'email', 'role']"
  [rowHover]="true"
  dataKey="userId"
  currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} usuarios"
  [showCurrentPageReport]="true"
  [rowsPerPageOptions]="[10, 20, 30]"
  [(selection)]="selectedUsers"
>
  <ng-template pTemplate="caption">
    <h5 class="m-0">Gestión de Usuarios</h5>
  </ng-template>
  <ng-template pTemplate="header" let-columns>
    <tr>
      <th style="width: 3rem">
        <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
      </th>
      <th *ngFor="let col of columns" pSortableColumn="{{ col.field }}">
        {{ col.header }}
        <p-sortIcon field="{{ col.field }}"></p-sortIcon>
      </th>
      <th style="min-width: 10rem">Acciones</th>
    </tr>
  </ng-template>
  <ng-template pTemplate="body" let-user>
    <tr>
      <td style="width: 3rem">
        <p-tableCheckbox [value]="user"></p-tableCheckbox>
      </td>
      <td>{{ user.userId }}</td>
      <td>{{ user.name }}</td>
      <td>{{ user.email }}</td>
      <td>{{ user.role }}</td>
      <td>
        <button
          pButton
          pRipple
          icon="pi pi-pencil"
          class="p-button-rounded p-button-info mr-2"
          (click)="editUser(user)"
        ></button>
        <button
          pButton
          pRipple
          icon="pi pi-trash"
          class="p-button-rounded p-button-danger"
          (click)="deleteUser(user.userId!)"
        ></button>
      </td>
    </tr>
  </ng-template>
  <ng-template pTemplate="emptymessage">
    <tr>
      <td colspan="5" class="text-center">No se encontraron usuarios.</td>
    </tr>
  </ng-template>
</p-table>

<p-dialog
  [(visible)]="userDialog"
  [style]="{ width: '450px' }"
  header="{{ user.userId ? 'Editar Usuario' : 'Nuevo Usuario' }}"
  [modal]="true"
>
  <ng-template pTemplate="content">
    <div class="field mb-3">
      <label for="name">Nombre:</label>
      <input
        type="text"
        id="name"
        name="name"
        [(ngModel)]="user.name"
        required
      />
    </div>

    <div class="field mb-3">
      <label for="email">Email:</label>
      <input
        type="email"
        id="email"
        name="email"
        [(ngModel)]="user.email"
        required
      />
    </div>

    <div class="field mb-3">
      <label for="password_hash">Contraseña:</label>
      <input
        type="password"
        id="password_hash"
        name="password_hash"
        [(ngModel)]="user.password_hash"
        required
      />
    </div>

    <div class="field mb-3">
      <label for="role">Rol:</label>
      <select id="role" name="role" [(ngModel)]="user.role" required>
        <option value="ADMIN">ADMIN</option>
        <option value="PROFESSOR">PROFESSOR</option>
        <option value="STUDENT">STUDENT</option>
      </select>
    </div>
  </ng-template>

  <ng-template pTemplate="footer">
    <button
      pButton
      pRipple
      label="Cancelar"
      icon="pi pi-times"
      class="p-button-text"
      (click)="hideDialog()"
    ></button>
    <button
      pButton
      pRipple
      label="{{ user.userId ? 'Actualizar' : 'Guardar' }}"
      icon="pi pi-check"
      class="p-button-text"
      (click)="saveUser()"
    ></button>
  </ng-template>
</p-dialog>