CREATE OR REPLACE PROCEDURE public.get_course_stats(
    OUT total_courses integer,
    OUT courses_last_month integer,
    INOUT last_courses refcursor,
    INOUT top_courses refcursor
)
LANGUAGE plpgsql
AS $BODY$
BEGIN
    -- Total de cursos
    SELECT COUNT(*) INTO total_courses FROM course;

    -- Cantidad de cursos creados en el último mes
    SELECT COUNT(*) INTO courses_last_month 
    FROM course 
    WHERE created_at >= NOW() - INTERVAL '1 month';

    -- Abrir cursor con los últimos 10 cursos + nombre del profesor
    OPEN last_courses FOR
        SELECT c.course_id,
               c.title,
               u.name AS teacher_name,
			   c.image_url,
               c.created_at
        FROM course c
        JOIN "user" u ON c.teacher_id = u.user_id
        ORDER BY c.created_at DESC
        LIMIT 10;

    -- Abrir cursor con los 5 cursos más comprados en toda la historia
    OPEN top_courses FOR
        SELECT c.course_id,
               c.title,
               u.name AS teacher_name,
			   c.image_url,
               COUNT(p.payment_id) AS total_purchases
        FROM payment p
        JOIN course c ON p.course_id = c.course_id
        JOIN "user" u ON c.teacher_id = u.user_id
        WHERE p.status = 'COMPLETADO'
        GROUP BY c.course_id, c.title, u.name
        ORDER BY total_purchases DESC
        LIMIT 5;
END;
$BODY$;


CREATE OR REPLACE PROCEDURE get_payments_stats(
    OUT monthly_payments refcursor,
    OUT total_revenue NUMERIC
)
LANGUAGE plpgsql
AS $$
BEGIN
    -- Pagos por mes en los últimos 6 meses
    OPEN monthly_payments FOR
    SELECT TO_CHAR(date_trunc('month', payment_date), 'YYYY-MM') AS payment_month,
           SUM(amount) AS total_amount
    FROM payment
    WHERE status = 'COMPLETADO'
      AND payment_date >= date_trunc('month', CURRENT_DATE) - interval '5 months'
    GROUP BY date_trunc('month', payment_date)
    ORDER BY date_trunc('month', payment_date);

    -- Total acumulado de ingresos (solo completados)
    SELECT COALESCE(SUM(amount), 0)
    INTO total_revenue
    FROM payment
    WHERE status = 'COMPLETADO';
END;
$$;
